"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function toRelative(e,r){var t=/\/$/.test(r)?r+"/":r,n=e.substr(t.length);return n.startsWith("/")?n.substr(1):n}function responseError(e){var r=new Error("Response error");return r.status=e.status,r}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_from=require("babel-runtime/core-js/array/from"),_from2=_interopRequireDefault(_from),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_getFiles=require("./get-files"),_getFiles2=_interopRequireDefault(_getFiles),_hash=require("./hash"),_hash2=_interopRequireDefault(_hash),_retry=require("./retry"),_retry2=_interopRequireDefault(_retry),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_agent=require("./agent"),_agent2=_interopRequireDefault(_agent),_events=require("events"),_events2=_interopRequireDefault(_events),_path=require("path"),_fsPromise=require("fs-promise"),_resumer=require("resumer"),_resumer2=_interopRequireDefault(_resumer),_splitArray=require("split-array"),_splitArray2=_interopRequireDefault(_splitArray),ONEMB=(0,_bytes2["default"])("1mb"),MAX_CONCURRENT=10,Now=function(e){function r(e,t){var n=t.forceNew,s=void 0===n?!1:n,a=t.debug,i=void 0===a?!1:a;(0,_classCallCheck3["default"])(this,r);var o=(0,_possibleConstructorReturn3["default"])(this,(0,_getPrototypeOf2["default"])(r).call(this));return o._token=e,o._debug=i,o._forceNew=s,o._agent=new _agent2["default"]("api.now.sh",{debug:i}),o._onRetry=o._onRetry.bind(o),o}return(0,_inherits3["default"])(r,e),(0,_createClass3["default"])(r,[{key:"create",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,r){var n,s,a,i,o,u,l,c=this,_=r.forceNew,f=r.forceSync;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return this._path=e,r.prev=1,r.next=4,(0,_fsPromise.stat)(e);case 4:r.next=9;break;case 6:throw r.prev=6,r.t0=r["catch"](1),new Error("Could not read directory "+e+".");case 9:return n=void 0,r.prev=10,r.next=13,(0,_fsPromise.readFile)((0,_path.resolve)(e,"package.json"));case 13:n=r.sent,n=JSON.parse(n),r.next=22;break;case 17:throw r.prev=17,r.t1=r["catch"](10),s=Error('Failed to read JSON in "'+e+'/package.json"'),s.userError=!0,s;case 22:if(null!=n.name&&"string"==typeof n.name){r.next=26;break}throw a=Error("Missing or invalid `name` in `package.json`."),a.userError=!0,a;case 26:if(n.scripts&&n.scripts.start){r.next=30;break}throw i=Error("Missing `start` script in `package.json`. See: https://docs.npmjs.com/cli/start."),i.userError=!0,i;case 30:return this._debug&&console.time("> [debug] Getting files"),r.next=33,(0,_getFiles2["default"])(e,n,{limit:ONEMB,debug:this._debug});case 33:return o=r.sent,this._debug&&console.timeEnd("> [debug] Getting files"),this._debug&&console.time("> [debug] Computing hashes"),r.next=38,(0,_hash2["default"])(o);case 38:return u=r.sent,this._debug&&console.timeEnd("> [debug] Computing hashes"),this._files=u,r.next=43,(0,_retry2["default"])(function(){var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(r){var s;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return c._debug&&console.time("> [debug] /create"),t.next=3,c._fetch("/create",{method:"POST",body:{forceNew:_,forceSync:f,name:n.name||(0,_path.basename)(e),description:n.description,files:(0,_from2["default"])(c._files).map(function(e){var r=(0,_slicedToArray3["default"])(e,2),t=r[0],n=r[1],s=n.data,a=n.name;return{sha:t,size:s.length,file:toRelative(a,c._path)}})}});case 3:if(s=t.sent,c._debug&&console.timeEnd("> [debug] /create"),403!==s.status){t.next=8;break}return c._debug&&console.log("> [debug] bailing on creating due to 403"),t.abrupt("return",r(responseError(s)));case 8:if(200===s.status){t.next=10;break}throw new Error("Deployment initialization failed");case 10:return t.abrupt("return",s.json());case 11:case"end":return t.stop()}},t,c)}));return function(e){return r.apply(this,arguments)}}(),{retries:3,minTimeout:2500,onRetry:this._onRetry});case 43:return l=r.sent,this._id=l.deploymentId,this._url=l.url,this._missing=l.missing||[],r.abrupt("return",this._url);case 48:case"end":return r.stop()}},t,this,[[1,6],[10,17]])}));return e}()},{key:"upload",value:function(){var e=this,r=(0,_splitArray2["default"])(this._missing,MAX_CONCURRENT);this._debug&&console.log("> [debug] Will upload "+(this._missing.length+" files in "+r.length+" ")+("steps of "+MAX_CONCURRENT+" uploads."));var t=function n(){_promise2["default"].all(r.shift().map(function(r){return(0,_retry2["default"])(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(t){var s,a,i,o,u;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return s=e._files.get(r),a=s.data,i=s.name,e._debug&&console.time("> [debug] /sync "+i),o=(0,_resumer2["default"])().queue(a).end(),n.next=7,e._fetch("/sync",{method:"POST",headers:{"Content-Type":"application/octet-stream","Content-Length":a.length,"x-now-deployment-id":e._id,"x-now-sha":r,"x-now-file":toRelative(i,e._path),"x-now-size":a.length},body:o});case 7:if(u=n.sent,e._debug&&console.timeEnd("> [debug] /sync "+i),403!==u.status){n.next=12;break}return e._debug&&console.log("> [debug] bailing on creating due to 403"),n.abrupt("return",t(responseError(u)));case 12:e.emit("upload",s);case 13:case"end":return n.stop()}},n,e)}));return function(e){return t.apply(this,arguments)}}(),{retries:5,randomize:!0,onRetry:e._onRetry})})).then(function(){return r.length?n():e.emit("complete")})["catch"](function(r){return e.emit("error",r)})};t()}},{key:"_onRetry",value:function(e){this._debug&&console.log("> [debug] Retrying: "+e.stack)}},{key:"close",value:function(){this._agent.close()}},{key:"_fetch",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,r){return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r.headers=r.headers||{},r.headers.authorization="Bearer "+this._token,t.next=4,this._agent.fetch(e,r);case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}},t,this)}));return e}()},{key:"url",get:function(){return this._url}},{key:"syncAmount",get:function(){var e=this;return this._syncAmount||(this._syncAmount=this._missing.map(function(r){return e._files.get(r).data.length}).reduce(function(e,r){return e+r},0)),this._syncAmount}}]),r}(_events2["default"]);exports["default"]=Now;
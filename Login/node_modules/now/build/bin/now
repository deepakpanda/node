#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function handleError(e){error(403===e.status?"Authentication error. Run `now -L` or `now --login` to log-in again.":e.userError?e.message:500===e.status?"Unexpected server error. Please retry.":"Unexpected error. Please try later. ("+e.message+")"),exit(1)}function error(e){console.error("> [31mError![39m "+e)}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),sync=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var o,t,n,a,c,i;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o=Date.now(),console.log('> Deploying "'+path+'"'),t=new _lib2["default"](e,{debug:debug}),r.prev=3,r.next=6,t.create(path,{forceNew:_commander2["default"].force,forceSync:_commander2["default"].forceSync});case 6:r.next=12;break;case 8:return r.prev=8,r.t0=r["catch"](3),handleError(r.t0),r.abrupt("return");case 12:if(n=t.url,a=(0,_ms2["default"])(new Date-o),!clipboard){r.next=26;break}return r.prev=15,r.next=18,(0,_copy2["default"])(n);case 18:console.log("> "+_chalk2["default"].cyan("Ready!")+" "+_chalk2["default"].bold("https://"+n)+" (copied to clipboard) ["+a+"]"),r.next=24;break;case 21:r.prev=21,r.t1=r["catch"](15),console.log("> "+_chalk2["default"].cyan("Ready!")+" "+_chalk2["default"].bold("https://"+n)+" ["+a+"]");case 24:r.next=27;break;case 26:console.log("> "+n+" ["+a+"]");case 27:c=new Date,i=function(){var e=(0,_ms2["default"])(new Date-c);console.log("> Sync complete ("+(0,_bytes2["default"])(t.syncAmount)+") ["+e+"] "),t.close(),exit(0)},t.syncAmount?!function(){var e=new _progress2["default"]("> Upload [:bar] :percent :etas",{width:20,complete:"=",incomplete:"",total:t.syncAmount});t.upload(),t.on("upload",function(r){var o=r.name,t=r.data,n=t.length;debug&&console.log("> [debug] Uploaded: "+o+" ("+(0,_bytes2["default"])(t.length)+")"),e.tick(n)}),t.on("complete",i),t.on("error",function(e){error("Upload failed"),handleError(e),exit(1)})}():(console.log("> Sync complete (cached)"),t.close(),exit(0));case 30:case"end":return r.stop()}},r,this,[[3,8],[15,21]])}));return function(r){return e.apply(this,arguments)}}(),_commander=require("commander"),_commander2=_interopRequireDefault(_commander),_progress=require("progress"),_progress2=_interopRequireDefault(_progress),_copy=require("../lib/copy"),_copy2=_interopRequireDefault(_copy),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_path=require("path"),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_checkUpdate=require("../lib/check-update"),_checkUpdate2=_interopRequireDefault(_checkUpdate),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_ms=require("ms"),_ms2=_interopRequireDefault(_ms);_commander2["default"].usage("[options]").version(require("../../package").version).option("-d, --debug","Debug mode [off]",!1).option("-f, --force","Force a new deployment even if nothing has changed",!1).option("-F, --forceSync","Force a new deployment even if nothing has changed and force syncing of all files",!1).option("-L, --login","Configure login").option("-C, --no-clipboard","Do not attempt to copy URL to clipboard").parse(process.argv);var path=_commander2["default"].args[_commander2["default"].args.length-1];path?"/"!==path[0]&&(path=(0,_path.resolve)(process.cwd(),path)):path=process.cwd();var debug=!!_commander2["default"].debug,clipboard=!_commander2["default"].noClipboard,config=cfg.read(),update=(0,_checkUpdate2["default"])({debug:debug}),exit=function(e){update.then(function(){return process.exit(e)}),setTimeout(function(){return process.exit(e)},1e3)};!config.token||_commander2["default"].login?(0,_login2["default"])().then(function(e){_commander2["default"].login?(console.log("> Logged in successfully. Token saved in ~/.now.json"),exit(0)):sync(e)["catch"](function(e){error("Unknown error: "+e.stack),exit(1)})})["catch"](function(e){error("Authentication error â€“ "+e.message),exit(1)}):sync(config.token)["catch"](function(e){error("Unknown error: "+e.stack),exit(1)});